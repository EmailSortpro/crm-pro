<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - Tableau de bord</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Styles sp√©cifiques pour le dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            padding: 1.5rem;
        }

        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            transition: background-color 0.2s;
        }

        .activity-item:hover {
            background: var(--gray-50);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .activity-icon.company {
            background: #dbeafe;
            color: #1e40af;
        }

        .activity-icon.license {
            background: #dcfce7;
            color: #166534;
        }

        .activity-icon.contact {
            background: #fef3c7;
            color: #92400e;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-stat {
            text-align: center;
            padding: 1rem;
            background: var(--white);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
        }

        .quick-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .quick-stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .quick-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Loading states */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--gray-500);
        }

        .data-error {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">üöÄ</span>
                <span class="logo-text">CRM Pro</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Accueil
                </a>
                <a href="dashboard.html" class="nav-link active">
                    <span class="nav-icon">üìä</span>
                    Tableau de bord
                </a>
                <a href="companies.html" class="nav-link">
                    <span class="nav-icon">üè¢</span>
                    Soci√©t√©s
                </a>
                <a href="contacts.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    Contacts
                </a>
                <a href="forecast.html" class="nav-link">
                    <span class="nav-icon">üìà</span>
                    Forecast
                </a>
                <a href="onboarding.html" class="nav-link">
                    <span class="nav-icon">üéØ</span>
                    Onboarding
                </a>
                <a href="licenses.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    Licences
                </a>
            </div>
            
            <div class="nav-user">
                <div class="user-info">
                    <span class="user-name" id="userName">Utilisateur</span>
                    <span class="user-role" id="userRole">user</span>
                </div>
                <button onclick="AuthService.logout()" class="logout-btn">
                    <span>üö™</span>
                    D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        <!-- En-t√™te de page -->
        <div style="margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: var(--gray-800); margin-bottom: 0.5rem;">
                üìä Tableau de bord
            </h1>
            <p style="color: var(--gray-600);">
                Vue d'ensemble de votre activit√© commerciale et de vos performances
            </p>
        </div>

        <!-- Statistiques principales -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-number" id="totalCompanies">-</div>
                <div class="stat-label">Soci√©t√©s</div>
                <div class="stat-subtitle" id="companiesBreakdown">Chargement...</div>
            </div>
            <div class="stat-card success">
                <div class="stat-number" id="totalContacts">-</div>
                <div class="stat-label">Contacts</div>
                <div class="stat-subtitle" id="contactsBreakdown">Chargement...</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-number" id="activeLicenses">-</div>
                <div class="stat-label">Licences Actives</div>
                <div class="stat-subtitle" id="licensesBreakdown">Chargement...</div>
            </div>
            <div class="stat-card error">
                <div class="stat-number" id="monthlyRevenue">-</div>
                <div class="stat-label">Revenus Mensuels</div>
                <div class="stat-subtitle" id="revenueBreakdown">Chargement...</div>
            </div>
        </div>

        <!-- Statistiques rapides -->
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-number" id="totalUsers">-</div>
                <div class="quick-stat-label">Utilisateurs</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-number" id="expiringLicenses">-</div>
                <div class="quick-stat-label">√Ä renouveler</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-number" id="conversionRate">-</div>
                <div class="quick-stat-label">Taux conversion</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-number" id="avgDealSize">-</div>
                <div class="quick-stat-label">Panier moyen</div>
            </div>
        </div>

        <!-- Graphiques et activit√© r√©cente -->
        <div class="dashboard-grid">
            <!-- Graphique des soci√©t√©s par statut -->
            <div class="card">
                <div class="card-header">
                    <h3>üìà R√©partition des soci√©t√©s</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="companiesChart"></canvas>
                        <div id="companiesChartLoading" class="chart-loading">
                            üîÑ Chargement du graphique...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graphique des revenus -->
            <div class="card">
                <div class="card-header">
                    <h3>üí∞ √âvolution des revenus</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                        <div id="revenueChartLoading" class="chart-loading">
                            üîÑ Chargement du graphique...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activit√© r√©cente et licences √† renouveler -->
        <div class="dashboard-grid">
            <!-- Activit√© r√©cente -->
            <div class="card">
                <div class="card-header">
                    <h3>üïí Activit√© r√©cente</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="recent-activity" id="recentActivity">
                        <div class="chart-loading">
                            üîÑ Chargement de l'activit√©...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Licences √† renouveler -->
            <div class="card">
                <div class="card-header">
                    <h3>‚ö†Ô∏è Licences √† renouveler</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="recent-activity" id="expiringLicensesList">
                        <div class="chart-loading">
                            üîÑ Chargement des √©ch√©ances...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="config.js"></script>
    <script>
        // Variables globales
        let dashboardData = {
            companies: [],
            contacts: [],
            licenses: [],
            stats: null
        };
        let charts = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            
            try {
                // V√©rifier l'authentification
                if (!await AuthService.requireAuth()) return;
                
                // Charger les informations utilisateur
                loadUserInfo();
                
                // Charger toutes les donn√©es
                await loadDashboardData();
                
                // Mettre √† jour l'interface
                updateDashboard();
                
            } catch (error) {
                console.error('Erreur initialisation dashboard:', error);
                showError('Erreur lors du chargement du tableau de bord');
                showErrorState();
            } finally {
                showLoading(false);
            }
        });

        function loadUserInfo() {
            const userInfo = AuthService.getUserInfo();
            if (userInfo) {
                document.getElementById('userName').textContent = userInfo.email.split('@')[0];
                document.getElementById('userRole').textContent = userInfo.role === 'admin' ? 'Admin' : 'Utilisateur';
            }
        }

        async function loadDashboardData() {
            console.log('üîÑ Chargement des donn√©es du dashboard...');
            
            try {
                // Charger toutes les donn√©es en parall√®le
                const [companiesResult, contactsResult, licensesResult, statsResult] = await Promise.all([
                    CRMService.getCompanies(),
                    CRMService.getContacts(),
                    CRMService.getLicenses(),
                    CRMService.getStats()
                ]);

                // Traiter les r√©sultats
                dashboardData.companies = companiesResult.success ? companiesResult.data : [];
                dashboardData.contacts = contactsResult.success ? contactsResult.data : [];
                dashboardData.licenses = licensesResult.success ? licensesResult.data : [];
                dashboardData.stats = statsResult.success ? statsResult.data : null;

                console.log('‚úÖ Donn√©es dashboard charg√©es:', {
                    companies: dashboardData.companies.length,
                    contacts: dashboardData.contacts.length,
                    licenses: dashboardData.licenses.length,
                    statsAvailable: !!dashboardData.stats
                });

            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es dashboard:', error);
                throw error;
            }
        }

        function updateDashboard() {
            updateMainStats();
            updateQuickStats();
            createCharts();
            updateRecentActivity();
            updateExpiringLicenses();
        }

        function updateMainStats() {
            const stats = dashboardData.stats;
            
            if (!stats) {
                console.warn('‚ö†Ô∏è Statistiques non disponibles, calcul manuel');
                calculateManualStats();
                return;
            }

            // Soci√©t√©s
            document.getElementById('totalCompanies').textContent = stats.totalCompanies || 0;
            document.getElementById('companiesBreakdown').textContent = 
                `${stats.prospects || 0} prospects ‚Ä¢ ${stats.clients || 0} clients`;

            // Contacts
            document.getElementById('totalContacts').textContent = stats.totalContacts || 0;
            document.getElementById('contactsBreakdown').textContent = 
                `R√©partis dans ${stats.totalCompanies || 0} soci√©t√©s`;

            // Licences
            document.getElementById('activeLicenses').textContent = stats.activeLicenses || 0;
            document.getElementById('licensesBreakdown').textContent = 
                `${stats.totalLicenseCount || 0} utilisateurs total`;

            // Revenus
            document.getElementById('monthlyRevenue').textContent = formatCurrency(stats.monthlyRevenue || 0);
            document.getElementById('revenueBreakdown').textContent = 
                `${formatCurrency((stats.monthlyRevenue || 0) * 12)} annuel`;
        }

        function calculateManualStats() {
            // Calcul manuel si les stats ne sont pas disponibles
            const companies = dashboardData.companies;
            const contacts = dashboardData.contacts;
            const licenses = dashboardData.licenses;

            // Soci√©t√©s
            const prospects = companies.filter(c => c.status === 'prospect').length;
            const clients = companies.filter(c => c.status === 'client' || c.status === 'onboarded').length;
            
            document.getElementById('totalCompanies').textContent = companies.length;
            document.getElementById('companiesBreakdown').textContent = `${prospects} prospects ‚Ä¢ ${clients} clients`;

            // Contacts
            document.getElementById('totalContacts').textContent = contacts.length;
            document.getElementById('contactsBreakdown').textContent = `R√©partis dans ${companies.length} soci√©t√©s`;

            // Licences
            const activeLicenses = licenses.filter(l => l.status === 'active').length;
            const totalUsers = licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (l.license_users?.filter(u => u.status === 'active').length || 0), 0);

            document.getElementById('activeLicenses').textContent = activeLicenses;
            document.getElementById('licensesBreakdown').textContent = `${totalUsers} utilisateurs total`;

            // Revenus
            const monthlyRevenue = licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (l.monthly_cost || 0), 0);

            document.getElementById('monthlyRevenue').textContent = formatCurrency(monthlyRevenue);
            document.getElementById('revenueBreakdown').textContent = `${formatCurrency(monthlyRevenue * 12)} annuel`;
        }

        function updateQuickStats() {
            const licenses = dashboardData.licenses;
            const activeLicenses = licenses.filter(l => l.status === 'active');
            
            // Utilisateurs total
            const totalUsers = activeLicenses.reduce((sum, l) => {
                return sum + (l.license_users?.filter(u => u.status === 'active').length || 0);
            }, 0);
            document.getElementById('totalUsers').textContent = totalUsers;

            // Licences √† renouveler (30 jours)
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiringCount = activeLicenses.filter(l => {
                if (!l.renewal_date) return false;
                const renewalDate = new Date(l.renewal_date);
                return renewalDate <= thirtyDaysFromNow && renewalDate >= now;
            }).length;
            document.getElementById('expiringLicenses').textContent = expiringCount;

            // Taux de conversion (prospects vers clients)
            const companies = dashboardData.companies;
            const prospects = companies.filter(c => c.status === 'prospect').length;
            const clients = companies.filter(c => c.status === 'client' || c.status === 'onboarded').length;
            const conversionRate = prospects > 0 ? Math.round((clients / (prospects + clients)) * 100) : 0;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;

        function updateQuickStats() {
            const licenses = dashboardData.licenses;
            const activeLicenses = licenses.filter(l => l.status === 'active');
            
            // Utilisateurs total
            const totalUsers = activeLicenses.reduce((sum, l) => {
                return sum + (l.license_users?.filter(u => u.status === 'active').length || 0);
            }, 0);
            document.getElementById('totalUsers').textContent = totalUsers;

            // Licences √† renouveler (30 jours)
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiringCount = activeLicenses.filter(l => {
                if (!l.renewal_date) return false;
                const renewalDate = new Date(l.renewal_date);
                return renewalDate <= thirtyDaysFromNow && renewalDate >= now;
            }).length;
            document.getElementById('expiringLicenses').textContent = expiringCount;

            // Taux de conversion (prospects vers clients)
            const companies = dashboardData.companies;
            const prospects = companies.filter(c => c.status === 'prospect').length;
            const clients = companies.filter(c => c.status === 'client' || c.status === 'onboarded').length;
            const conversionRate = prospects > 0 ? Math.round((clients / (prospects + clients)) * 100) : 0;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;

            // Panier moyen
            const monthlyRevenue = activeLicenses.reduce((sum, l) => sum + (l.monthly_cost || 0), 0);
            const avgDealSize = activeLicenses.length > 0 ? monthlyRevenue / activeLicenses.length : 0;
            document.getElementById('avgDealSize').textContent = formatCurrency(avgDealSize);
        }

        function createCharts() {
            createCompaniesChart();
            createRevenueChart();
        }

        function createCompaniesChart() {
            const canvas = document.getElementById('companiesChart');
            const loading = document.getElementById('companiesChartLoading');
            
            if (!canvas) return;

            try {
                const companies = dashboardData.companies;
                const statusCounts = {
                    prospect: companies.filter(c => c.status === 'prospect').length,
                    sponsor: companies.filter(c => c.status === 'sponsor').length,
                    client: companies.filter(c => c.status === 'client').length,
                    onboarded: companies.filter(c => c.status === 'onboarded').length
                };

                // Masquer le loading
                loading.style.display = 'none';
                canvas.style.display = 'block';

                // D√©truire le graphique existant
                if (charts.companies) {
                    charts.companies.destroy();
                }

                const ctx = canvas.getContext('2d');
                charts.companies = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Prospects', 'Sponsors', 'Clients', 'Onboard√©s'],
                        datasets: [{
                            data: [statusCounts.prospect, statusCounts.sponsor, statusCounts.client, statusCounts.onboarded],
                            backgroundColor: [
                                '#fbbf24', // prospect - yellow
                                '#a855f7', // sponsor - purple
                                '#3b82f6', // client - blue
                                '#10b981'  // onboarded - green
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Erreur cr√©ation graphique soci√©t√©s:', error);
                loading.innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
            }
        }

        function createRevenueChart() {
            const canvas = document.getElementById('revenueChart');
            const loading = document.getElementById('revenueChartLoading');
            
            if (!canvas) return;

            try {
                // G√©n√©rer des donn√©es de revenus sur 6 mois
                const months = [];
                const revenueData = [];
                const now = new Date();
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }));
                    
                    // Simuler une progression des revenus
                    const baseRevenue = dashboardData.licenses
                        .filter(l => l.status === 'active')
                        .reduce((sum, l) => sum + (l.monthly_cost || 0), 0);
                    
                    const variation = 1 + (Math.random() * 0.4 - 0.2); // ¬±20% de variation
                    revenueData.push(Math.round(baseRevenue * variation));
                }

                // Masquer le loading
                loading.style.display = 'none';
                canvas.style.display = 'block';

                // D√©truire le graphique existant
                if (charts.revenue) {
                    charts.revenue.destroy();
                }

                const ctx = canvas.getContext('2d');
                charts.revenue = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Revenus mensuels',
                            data: revenueData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Revenus: ${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Erreur cr√©ation graphique revenus:', error);
                loading.innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
            }
        }

        function updateRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            try {
                // G√©n√©rer des activit√©s r√©centes bas√©es sur les donn√©es r√©elles
                const activities = [];
                
                // Activit√©s des soci√©t√©s (r√©centes)
                const recentCompanies = dashboardData.companies
                    .sort((a, b) => new Date(b.created_at || b.updated_at) - new Date(a.created_at || a.updated_at))
                    .slice(0, 3);
                
                recentCompanies.forEach(company => {
                    activities.push({
                        type: 'company',
                        icon: 'üè¢',
                        title: `Soci√©t√© ${company.name}`,
                        description: `Statut: ${getStatusText(company.status)}`,
                        time: formatRelativeTime(company.created_at || company.updated_at)
                    });
                });

                // Activit√©s des licences (r√©centes)
                const recentLicenses = dashboardData.licenses
                    .sort((a, b) => new Date(b.created_at || b.updated_at) - new Date(a.created_at || a.updated_at))
                    .slice(0, 3);
                
                recentLicenses.forEach(license => {
                    const companyName = license.companies?.name || 'Soci√©t√© inconnue';
                    activities.push({
                        type: 'license',
                        icon: 'üìÑ',
                        title: `Licence ${companyName}`,
                        description: `Plan: ${license.license_plans?.name || 'Plan inconnu'}`,
                        time: formatRelativeTime(license.created_at || license.updated_at)
                    });
                });

                // Activit√©s des contacts (r√©cents)
                const recentContacts = dashboardData.contacts
                    .sort((a, b) => new Date(b.created_at || b.updated_at) - new Date(a.created_at || a.updated_at))
                    .slice(0, 2);
                
                recentContacts.forEach(contact => {
                    const companyName = contact.companies?.name || 'Soci√©t√© inconnue';
                    activities.push({
                        type: 'contact',
                        icon: 'üë§',
                        title: `Contact ${contact.first_name} ${contact.last_name}`,
                        description: `Ajout√© √† ${companyName}`,
                        time: formatRelativeTime(contact.created_at || contact.updated_at)
                    });
                });

                // Trier par date et limiter √† 8 activit√©s
                activities.sort((a, b) => {
                    // Tri approximatif bas√© sur le texte du temps
                    const aTime = a.time.includes('√† l\'instant') ? 0 : 
                                 a.time.includes('minute') ? parseInt(a.time) :
                                 a.time.includes('heure') ? parseInt(a.time) * 60 : 
                                 parseInt(a.time) * 1440;
                    const bTime = b.time.includes('√† l\'instant') ? 0 : 
                                 b.time.includes('minute') ? parseInt(b.time) :
                                 b.time.includes('heure') ? parseInt(b.time) * 60 : 
                                 parseInt(b.time) * 1440;
                    return aTime - bTime;
                });

                const limitedActivities = activities.slice(0, 8);

                if (limitedActivities.length === 0) {
                    container.innerHTML = `
                        <div class="data-error">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
                            <p>Aucune activit√© r√©cente</p>
                            <p style="font-size: 0.875rem; color: var(--gray-500);">
                                Les nouvelles activit√©s appara√Ætront ici
                            </p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = limitedActivities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.type}">
                            ${activity.icon}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${escapeHtml(activity.title)}</div>
                            <div class="activity-description">${escapeHtml(activity.description)}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erreur g√©n√©ration activit√© r√©cente:', error);
                container.innerHTML = '<div class="data-error">‚ùå Erreur de chargement de l\'activit√©</div>';
            }
        }

        function updateExpiringLicenses() {
            const container = document.getElementById('expiringLicensesList');
            
            try {
                const now = new Date();
                const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                const expiringLicenses = dashboardData.licenses.filter(license => {
                    if (license.status !== 'active' || !license.renewal_date) return false;
                    const renewalDate = new Date(license.renewal_date);
                    return renewalDate <= thirtyDaysFromNow && renewalDate >= now;
                });

                if (expiringLicenses.length === 0) {
                    container.innerHTML = `
                        <div class="data-error">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚úÖ</div>
                            <p>Aucune licence √† renouveler</p>
                            <p style="font-size: 0.875rem; color: var(--gray-500);">
                                Toutes vos licences sont √† jour
                            </p>
                        </div>
                    `;
                    return;
                }

                // Trier par date de renouvellement (plus proche en premier)
                expiringLicenses.sort((a, b) => new Date(a.renewal_date) - new Date(b.renewal_date));

                container.innerHTML = expiringLicenses.map(license => {
                    const companyName = license.companies?.name || 'Soci√©t√© inconnue';
                    const planName = license.license_plans?.name || 'Plan inconnu';
                    const daysUntilRenewal = getDaysUntilRenewal(license.renewal_date);
                    
                    let urgencyClass = 'license';
                    let urgencyIcon = 'üìÑ';
                    
                    if (daysUntilRenewal.includes('aujourd\'hui') || daysUntilRenewal.includes('demain')) {
                        urgencyClass = 'contact'; // Orange/rouge
                        urgencyIcon = 'üö®';
                    } else if (daysUntilRenewal.includes('Dans') && parseInt(daysUntilRenewal) <= 7) {
                        urgencyClass = 'contact'; // Orange
                        urgencyIcon = '‚ö†Ô∏è';
                    }

                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${urgencyClass}">
                                ${urgencyIcon}
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${escapeHtml(companyName)}</div>
                                <div class="activity-description">${escapeHtml(planName)} ‚Ä¢ ${formatCurrency(license.monthly_cost || 0)}/mois</div>
                                <div class="activity-time">${daysUntilRenewal}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Erreur g√©n√©ration licences expirantes:', error);
                container.innerHTML = '<div class="data-error">‚ùå Erreur de chargement des √©ch√©ances</div>';
            }
        }

        // Fonctions utilitaires
        function getStatusText(status) {
            const statusMap = {
                'prospect': 'Prospect',
                'sponsor': 'Sponsor',
                'client': 'Client',
                'onboarded': 'Onboard√©'
            };
            return statusMap[status] || status;
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return 'Date inconnue';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                if (diffMins < 1) return '√Ä l\'instant';
                if (diffMins < 60) return `Il y a ${diffMins} minute${diffMins > 1 ? 's' : ''}`;
                if (diffHours < 24) return `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
                if (diffDays < 7) return `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
                
                return formatDateShort(dateString);
            } catch (error) {
                return 'Date invalide';
            }
        }

        function getDaysUntilRenewal(renewalDate) {
            if (!renewalDate) return 'Non d√©fini';
            
            const now = new Date();
            const renewal = new Date(renewalDate);
            const diffTime = renewal - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `Expir√© depuis ${Math.abs(diffDays)} jour(s)`;
            } else if (diffDays === 0) {
                return 'Expire aujourd\'hui';
            } else if (diffDays === 1) {
                return 'Expire demain';
            } else if (diffDays <= 30) {
                return `Dans ${diffDays} jour(s)`;
            } else {
                return `Dans ${Math.ceil(diffDays / 30)} mois`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showErrorState() {
            // Afficher un √©tat d'erreur pour tous les composants
            document.getElementById('totalCompanies').textContent = '-';
            document.getElementById('companiesBreakdown').textContent = 'Erreur de chargement';
            
            document.getElementById('totalContacts').textContent = '-';
            document.getElementById('contactsBreakdown').textContent = 'Erreur de chargement';
            
            document.getElementById('activeLicenses').textContent = '-';
            document.getElementById('licensesBreakdown').textContent = 'Erreur de chargement';
            
            document.getElementById('monthlyRevenue').textContent = '-';
            document.getElementById('revenueBreakdown').textContent = 'Erreur de chargement';

            // Quick stats
            document.getElementById('totalUsers').textContent = '-';
            document.getElementById('expiringLicenses').textContent = '-';
            document.getElementById('conversionRate').textContent = '-';
            document.getElementById('avgDealSize').textContent = '-';

            // Graphiques
            document.getElementById('companiesChartLoading').innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
            document.getElementById('revenueChartLoading').innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
            
            // Activit√© et licences expirantes
            document.getElementById('recentActivity').innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
            document.getElementById('expiringLicensesList').innerHTML = '<div class="data-error">‚ùå Erreur de chargement</div>';
        }

        // Actualisation automatique toutes les 5 minutes
        setInterval(async () => {
            try {
                console.log('üîÑ Actualisation automatique du dashboard...');
                await loadDashboardData();
                updateDashboard();
            } catch (error) {
                console.error('Erreur actualisation automatique:', error);
            }
        }, 5 * 60 * 1000);

        // Gestion de la visibilit√© de la page
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // Actualiser quand la page redevient visible
                setTimeout(async () => {
                    try {
                        await loadDashboardData();
                        updateDashboard();
                    } catch (error) {
                        console.error('Erreur actualisation visibilit√©:', error);
                    }
                }, 1000);
            }
        });

        // Fonction de debug
        window.debugDashboard = () => {
            console.log('üîß Debug Dashboard:', dashboardData);
        };
    </script>
</body>
</html>
