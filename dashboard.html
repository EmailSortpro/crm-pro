<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span class="logo-icon">üöÄ</span>
                <span class="logo-text">CRM Pro</span>
            </a>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Accueil
                </a>
                <a href="dashboard.html" class="nav-link active">
                    <span class="nav-icon">üìä</span>
                    Tableau de bord
                </a>
                <a href="companies.html" class="nav-link">
                    <span class="nav-icon">üè¢</span>
                    Soci√©t√©s
                </a>
                <a href="contacts.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    Contacts
                </a>
                <a href="forecast.html" class="nav-link">
                    <span class="nav-icon">üìà</span>
                    Forecast
                </a>
                <a href="onboarding.html" class="nav-link">
                    <span class="nav-icon">üéØ</span>
                    Onboarding
                </a>
                <a href="licenses.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    Licences
                </a>
            </div>
            
            <div class="nav-user">
                <div class="user-info">
                    <div>
                        <div class="user-name" id="userName">Utilisateur</div>
                        <div class="user-role" id="userRole">user</div>
                    </div>
                </div>
                <button onclick="AuthService.logout()" class="logout-btn">
                    <span>üö™</span>
                    D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
        <!-- Titre de la page -->
        <div style="margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: var(--gray-800); margin-bottom: 0.5rem;">
                üìä Dashboard
            </h1>
            <p style="color: var(--gray-600);">
                Vue d'ensemble de votre activit√© CRM avec les donn√©es de votre base Supabase
            </p>
            <button onclick="refreshDashboard()" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;">
                üîÑ Actualiser les donn√©es
            </button>
        </div>

        <!-- Statistiques principales -->
        <section class="stats-grid" id="statsContainer">
            <!-- Les stats seront charg√©es dynamiquement -->
        </section>

        <!-- Graphiques et donn√©es -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <!-- Graphique √©volution des soci√©t√©s -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìà R√©partition des soci√©t√©s</h3>
                    <p class="card-subtitle">Par statut dans votre base Supabase</p>
                </div>
                <div class="card-body">
                    <canvas id="companiesChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Graphique revenus -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üí∞ Revenus par plan</h3>
                    <p class="card-subtitle">Revenus mensuels par type de licence</p>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Tableaux de donn√©es -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Licences √† renouveler -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">‚ö†Ô∏è Licences √† renouveler</h3>
                    <p class="card-subtitle">√âch√©ances dans les 30 prochains jours</p>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table" id="renewalsTable">
                            <thead>
                                <tr>
                                    <th>Soci√©t√©</th>
                                    <th>√âch√©ance</th>
                                    <th>Montant</th>
                                </tr>
                            </thead>
                            <tbody id="renewalsTableBody">
                                <!-- Donn√©es charg√©es dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activit√© r√©cente bas√©e sur les vraies donn√©es -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üïí Donn√©es r√©centes</h3>
                    <p class="card-subtitle">Derniers √©l√©ments cr√©√©s dans Supabase</p>
                </div>
                <div class="card-body">
                    <div id="recentActivity">
                        <!-- Activit√© charg√©e dynamiquement -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions rapides -->
        <section style="margin-top: 3rem;">
            <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--gray-800);">
                üöÄ Actions rapides
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <a href="companies.html?action=add" class="btn btn-primary" style="padding: 1.5rem; flex-direction: column; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 0.5rem;">üè¢</span>
                    <strong>Nouvelle soci√©t√©</strong>
                    <small style="opacity: 0.8;">Ajouter un prospect</small>
                </a>
                
                <a href="licenses.html?action=add" class="btn btn-primary" style="padding: 1.5rem; flex-direction: column; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 0.5rem;">üîë</span>
                    <strong>Nouvelle licence</strong>
                    <small style="opacity: 0.8;">Cr√©er une licence</small>
                </a>
                
                <a href="onboarding.html" class="btn btn-primary" style="padding: 1.5rem; flex-direction: column; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 0.5rem;">üéØ</span>
                    <strong>Onboarding</strong>
                    <small style="opacity: 0.8;">Suivre les √©tapes</small>
                </a>
                
                <a href="forecast.html" class="btn btn-primary" style="padding: 1.5rem; flex-direction: column; text-align: center;">
                    <span style="font-size: 2rem; margin-bottom: 0.5rem;">üìà</span>
                    <strong>Forecast</strong>
                    <small style="opacity: 0.8;">Pr√©voir les ventes</small>
                </a>
            </div>
        </section>
    </main>

    <script src="config.js"></script>
    <script>
        // Variables globales pour les vraies donn√©es UNIQUEMENT
        let companies = [];
        let licenses = [];
        let contacts = [];
        let companiesChart = null;
        let revenueChart = null;

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading(true);
                
                // V√©rifier l'authentification
                if (!await AuthService.requireAuth()) return;

                // Charger les informations utilisateur
                loadUserInfo();

                // Charger UNIQUEMENT les donn√©es R√âELLES du dashboard
                await loadRealDashboardData();
                
            } catch (error) {
                console.error('Erreur dashboard:', error);
                showError('Erreur lors du chargement du dashboard');
                renderErrorState();
            } finally {
                showLoading(false);
            }
        });

        // Charger les informations utilisateur
        function loadUserInfo() {
            try {
                const userInfo = AuthService.getUserInfo();
                if (userInfo) {
                    document.getElementById('userName').textContent = userInfo.email.split('@')[0];
                    document.getElementById('userRole').textContent = userInfo.role === 'admin' ? 'Admin' : 'Utilisateur';
                }
            } catch (error) {
                console.error('Erreur chargement utilisateur:', error);
                document.getElementById('userName').textContent = 'Utilisateur';
                document.getElementById('userRole').textContent = 'User';
            }
        }

        // Charger UNIQUEMENT les donn√©es R√âELLES de Supabase
        async function loadRealDashboardData() {
            try {
                console.log('üîÑ Chargement des donn√©es R√âELLES du dashboard...');
                
                // Charger toutes les donn√©es en parall√®le avec timeout
                const [companiesResult, licensesResult, contactsResult] = await Promise.all([
                    withTimeout(CRMService.getCompanies(), 10000),
                    withTimeout(CRMService.getLicenses(), 10000),
                    withTimeout(CRMService.getContacts(), 10000)
                ]);
                
                console.log('üìä R√©sultats bruts dashboard:', {
                    companies: companiesResult,
                    licenses: licensesResult,
                    contacts: contactsResult
                });
                
                // Traiter les soci√©t√©s
                if (companiesResult.success && companiesResult.data) {
                    companies = companiesResult.data;
                    console.log('‚úÖ Soci√©t√©s charg√©es:', companies.length);
                } else {
                    console.log('‚ùå Erreur soci√©t√©s:', companiesResult.error);
                    companies = [];
                }
                
                // Traiter les licences
                if (licensesResult.success && licensesResult.data) {
                    licenses = licensesResult.data;
                    console.log('‚úÖ Licences charg√©es:', licenses.length);
                } else {
                    console.log('‚ùå Erreur licences:', licensesResult.error);
                    licenses = [];
                }
                
                // Traiter les contacts
                if (contactsResult.success && contactsResult.data) {
                    contacts = contactsResult.data;
                    console.log('‚úÖ Contacts charg√©s:', contacts.length);
                } else {
                    console.log('‚ùå Erreur contacts:', contactsResult.error);
                    contacts = [];
                }
                
                // Calculer et afficher les statistiques r√©elles
                const realStats = calculateRealStats();
                console.log('üìà Statistiques calcul√©es:', realStats);
                
                // Afficher toutes les donn√©es
                renderStats(realStats);
                renderCharts();
                renderRenewalsTable();
                renderRecentActivity();
                
            } catch (error) {
                console.error('‚ùå Erreur fatale dashboard:', error);
                throw error;
            }
        }

        // Calculer les statistiques bas√©es UNIQUEMENT sur les donn√©es Supabase
        function calculateRealStats() {
            console.log('üßÆ Calcul des statistiques avec les donn√©es:', {
                companiesCount: companies.length,
                licensesCount: licenses.length,
                contactsCount: contacts.length
            });
            
            // Statistiques des soci√©t√©s
            const totalCompanies = companies.length;
            const prospects = companies.filter(c => c.status === 'prospect').length;
            const sponsors = companies.filter(c => c.status === 'sponsor').length;
            const clients = companies.filter(c => c.status === 'client').length;
            const onboarded = companies.filter(c => c.status === 'onboarded').length;
            
            // Statistiques des licences
            const activeLicenses = licenses.filter(l => l.status === 'active').length;
            const totalLicenseCount = licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (l.license_count || 0), 0);
            const monthlyRevenue = licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (l.monthly_cost || 0), 0);
            
            // Licences expirant dans les 30 jours
            const now = new Date();
            const in30Days = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
            const expiringLicenses = licenses.filter(l => {
                if (l.status !== 'active' || !l.renewal_date) return false;
                const renewalDate = new Date(l.renewal_date);
                return renewalDate >= now && renewalDate <= in30Days;
            });
            
            // Statistiques des contacts
            const totalContacts = contacts.length;
            const adminContacts = contacts.filter(c => c.is_admin_contact).length;
            const paymentContacts = contacts.filter(c => c.is_payment_contact).length;
            
            const stats = {
                totalCompanies,
                prospects,
                sponsors,
                clients,
                onboarded,
                activeLicenses,
                totalLicenseCount,
                monthlyRevenue,
                expiringLicenses: expiringLicenses.length,
                totalContacts,
                adminContacts,
                paymentContacts
            };
            
            console.log('üìä Statistiques finales:', stats);
            return stats;
        }

        // Rendu des statistiques avec les vraies donn√©es
        function renderStats(stats) {
            const container = document.getElementById('statsContainer');
            
            // Calculs des pourcentages
            const prospectPercent = stats.totalCompanies > 0 ? Math.round(stats.prospects / stats.totalCompanies * 100) : 0;
            const clientPercent = stats.totalCompanies > 0 ? Math.round(stats.clients / stats.totalCompanies * 100) : 0;
            const sponsorPercent = stats.totalCompanies > 0 ? Math.round(stats.sponsors / stats.totalCompanies * 100) : 0;
            const onboardedPercent = stats.totalCompanies > 0 ? Math.round(stats.onboarded / stats.totalCompanies * 100) : 0;
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalCompanies}</div>
                    <div class="stat-label">Total Soci√©t√©s</div>
                    <div class="stat-change">${stats.totalContacts} contacts</div>
                </div>
                
                <div class="stat-card warning">
                    <div class="stat-number">${stats.prospects}</div>
                    <div class="stat-label">Prospects</div>
                    <div class="stat-change">${prospectPercent}% du total</div>
                </div>
                
                <div class="stat-card info">
                    <div class="stat-number">${stats.sponsors}</div>
                    <div class="stat-label">Sponsors</div>
                    <div class="stat-change">${sponsorPercent}% du total</div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-number">${stats.clients}</div>
                    <div class="stat-label">Clients</div>
                    <div class="stat-change">${clientPercent}% du total</div>
                </div>
                
                <div class="stat-card primary">
                    <div class="stat-number">${stats.onboarded}</div>
                    <div class="stat-label">Onboard√©s</div>
                    <div class="stat-change">${onboardedPercent}% du total</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number">${stats.totalLicenseCount}</div>
                    <div class="stat-label">Licences Actives</div>
                    <div class="stat-change">${stats.activeLicenses} soci√©t√©(s)</div>
                </div>
                
                <div class="stat-card success">
                    <div class="stat-number">${formatCurrency(stats.monthlyRevenue)}</div>
                    <div class="stat-label">Revenus Mensuels</div>
                    <div class="stat-change">MRR (Monthly Recurring Revenue)</div>
                </div>
                
                <div class="stat-card error">
                    <div class="stat-number">${stats.expiringLicenses}</div>
                    <div class="stat-label">Licences √† renouveler</div>
                    <div class="stat-change">Dans les 30 jours</div>
                </div>
            `;
        }

        // Rendu des graphiques avec les vraies donn√©es
        function renderCharts() {
            renderCompaniesChart();
            renderRevenueChart();
        }

        // Graphique r√©partition des soci√©t√©s avec vraies donn√©es
        function renderCompaniesChart() {
            const ctx = document.getElementById('companiesChart').getContext('2d');
            
            if (companiesChart) {
                companiesChart.destroy();
            }
            
            // Calculer la r√©partition r√©elle
            const prospects = companies.filter(c => c.status === 'prospect').length;
            const sponsors = companies.filter(c => c.status === 'sponsor').length;
            const clients = companies.filter(c => c.status === 'client').length;
            const onboarded = companies.filter(c => c.status === 'onboarded').length;
            
            console.log('üìà Donn√©es graphique soci√©t√©s:', { prospects, sponsors, clients, onboarded });
            
            // Ne montrer que les statuts qui ont des donn√©es
            const labels = [];
            const data = [];
            const colors = [];
            
            if (prospects > 0) {
                labels.push('Prospects');
                data.push(prospects);
                colors.push('#f59e0b');
            }
            if (sponsors > 0) {
                labels.push('Sponsors');
                data.push(sponsors);
                colors.push('#8b5cf6');
            }
            if (clients > 0) {
                labels.push('Clients');
                data.push(clients);
                colors.push('#3b82f6');
            }
            if (onboarded > 0) {
                labels.push('Onboard√©s');
                data.push(onboarded);
                colors.push('#10b981');
            }
            
            // Si aucune donn√©e, afficher un message
            if (data.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune soci√©t√© dans la base', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            companiesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Graphique revenus par plan avec vraies donn√©es
        function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            // Grouper les revenus par plan de licence
            const revenueByPlan = {};
            licenses.filter(l => l.status === 'active').forEach(license => {
                const planName = license.license_plans?.name || 'Plan inconnu';
                if (!revenueByPlan[planName]) {
                    revenueByPlan[planName] = 0;
                }
                revenueByPlan[planName] += license.monthly_cost || 0;
            });
            
            const planNames = Object.keys(revenueByPlan);
            const planRevenues = Object.values(revenueByPlan);
            
            console.log('üí∞ Donn√©es graphique revenus:', { planNames, planRevenues });
            
            // Si aucune donn√©e, afficher un message
            if (planNames.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune licence active', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: planNames,
                    datasets: [{
                        label: 'Revenus (‚Ç¨/mois)',
                        data: planRevenues,
                        backgroundColor: [
                            '#667eea',
                            '#764ba2', 
                            '#48bb78',
                            '#ed8936',
                            '#9f7aea'
                        ].slice(0, planNames.length),
                        borderWidth: 1,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Tableau des licences √† renouveler avec vraies donn√©es
        function renderRenewalsTable() {
            const tableBody = document.getElementById('renewalsTableBody');
            
            // Licences expirant dans les 30 jours
            const now = new Date();
            const in30Days = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
            const expiringLicenses = licenses.filter(l => {
                if (l.status !== 'active' || !l.renewal_date) return false;
                const renewalDate = new Date(l.renewal_date);
                return renewalDate >= now && renewalDate <= in30Days;
            });
            
            console.log('‚ö†Ô∏è Licences √† renouveler:', expiringLicenses.length);
            
            if (expiringLicenses.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            üéâ Aucune licence √† renouveler dans les 30 prochains jours
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = expiringLicenses.map(license => {
                const renewalDate = new Date(license.renewal_date);
                const diffTime = renewalDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let urgencyClass = '';
                if (diffDays <= 7) urgencyClass = 'error';
                else if (diffDays <= 15) urgencyClass = 'warning';
                else urgencyClass = 'info';
                
                return `
                    <tr onclick="window.location.href='licenses.html'" style="cursor: pointer;">
                        <td>
                            <strong>${license.companies?.name || 'Soci√©t√© inconnue'}</strong>
                            <br>
                            <small style="color: var(--gray-500);">${license.license_count} licence(s)</small>
                        </td>
                        <td>
                            <span class="stat-card ${urgencyClass}" style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                ${diffDays} jour${diffDays > 1 ? 's' : ''}
                            </span>
                            <br>
                            <small style="color: var(--gray-500);">${formatDateShort(license.renewal_date)}</small>
                        </td>
                        <td>
                            <strong>${formatCurrency(license.monthly_cost)}</strong>
                            <br>
                            <small style="color: var(--gray-500);">par mois</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Activit√© r√©cente bas√©e UNIQUEMENT sur les vraies donn√©es
        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            
            const activities = [];
            
            // Derni√®res soci√©t√©s cr√©√©es
            companies
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 3)
                .forEach(company => {
                    activities.push({
                        icon: company.status === 'prospect' ? 'üè¢' : 'ü§ù',
                        action: `Soci√©t√© ${company.status}`,
                        details: company.name,
                        time: getTimeAgo(company.created_at),
                        actualDate: company.created_at
                    });
                });
            
            // Derniers contacts cr√©√©s
            contacts
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 3)
                .forEach(contact => {
                    const companyName = companies.find(c => c.id === contact.company_id)?.name;
                    activities.push({
                        icon: 'üë§',
                        action: 'Contact ajout√©',
                        details: `${contact.first_name} ${contact.last_name}${companyName ? ' - ' + companyName : ''}`,
                        time: getTimeAgo(contact.created_at),
                        actualDate: contact.created_at
                    });
                });
            
            // Licences actives r√©centes
            licenses
                .filter(l => l.status === 'active')
                .sort((a, b) => new Date(b.created_at || b.start_date) - new Date(a.created_at || a.start_date))
                .slice(0, 2)
                .forEach(license => {
                    activities.push({
                        icon: 'üîë',
                        action: 'Licence active',
                        details: `${license.companies?.name || 'Soci√©t√©'} - ${license.license_count} licence(s)`,
                        time: getTimeAgo(license.created_at || license.start_date),
                        actualDate: license.created_at || license.start_date
                    });
                });
            
            // Trier par date et prendre les 5 plus r√©cents
            activities.sort((a, b) => new Date(b.actualDate) - new Date(a.actualDate));
            const recentActivities = activities.slice(0, 5);
            
            console.log('üïí Activit√©s r√©centes:', recentActivities.length);
            
            if (recentActivities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                        üìÇ Aucune activit√© r√©cente
                        <br>
                        <small>Commencez par ajouter des soci√©t√©s ou contacts</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentActivities.map(activity => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid var(--gray-200);">
                    <div style="font-size: 1.5rem;">${activity.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--gray-800); margin-bottom: 0.25rem;">
                            ${activity.action}
                        </div>
                        <div style="color: var(--gray-600); font-size: 0.875rem;">
                            ${activity.details}
                        </div>
                    </div>
                    <div style="color: var(--gray-500); font-size: 0.75rem;">
                        ${activity.time}
                    </div>
                </div>
            `).join('');
        }

        // Fonction pour calculer le temps √©coul√©
        function getTimeAgo(dateString) {
            if (!dateString) return 'Date inconnue';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return "Aujourd'hui";
            if (diffDays === 1) return "Hier";
            if (diffDays < 7) return `Il y a ${diffDays} jours`;
            if (diffDays < 30) return `Il y a ${Math.ceil(diffDays / 7)} semaine(s)`;
            return `Il y a ${Math.ceil(diffDays / 30)} mois`;
        }

        // Affichage d'erreur si les donn√©es ne peuvent pas √™tre charg√©es
        function renderErrorState() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-card error">
                    <div class="stat-number">‚ùå</div>
                    <div class="stat-label">Erreur de connexion</div>
                    <div class="stat-change">Impossible de charger les donn√©es</div>
                </div>
            `;
            
            // Graphiques d'erreur
            const companiesCtx = document.getElementById('companiesChart').getContext('2d');
            companiesCtx.clearRect(0, 0, companiesCtx.canvas.width, companiesCtx.canvas.height);
            companiesCtx.font = '16px Arial';
            companiesCtx.fillStyle = '#dc2626';
            companiesCtx.textAlign = 'center';
            companiesCtx.fillText('Erreur de chargement', companiesCtx.canvas.width / 2, companiesCtx.canvas.height / 2);
            
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueCtx.clearRect(0, 0, revenueCtx.canvas.width, revenueCtx.canvas.height);
            revenueCtx.font = '16px Arial';
            revenueCtx.fillStyle = '#dc2626';
            revenueCtx.textAlign = 'center';
            revenueCtx.fillText('Erreur de chargement', revenueCtx.canvas.width / 2, revenueCtx.canvas.height / 2);
        }

        // Rafra√Æchir les donn√©es
        async function refreshDashboard() {
            try {
                showLoading(true);
                await loadRealDashboardData();
                showSuccess('Dashboard mis √† jour avec les derni√®res donn√©es !');
            } catch (error) {
                console.error('Erreur rafra√Æchissement:', error);
                showError('Erreur lors de la mise √† jour des donn√©es');
            } finally {
                showLoading(false);
            }
        }

        // Fonction utilitaire pour les timeouts
        function withTimeout(promise, timeoutMs = 10000) {
            return Promise.race([
                promise,
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Timeout')), timeoutMs)
                )
            ]);
        }

        // Auto-refresh toutes les 5 minutes
        setInterval(refreshDashboard, 5 * 60 * 1000);

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshDashboard();
                        break;
                    case '1':
                        e.preventDefault();
                        window.location.href = 'companies.html';
                        break;
                    case '2':
                        e.preventDefault();
                        window.location.href = 'forecast.html';
                        break;
                    case '3':
                        e.preventDefault();
                        window.location.href = 'onboarding.html';
                        break;
                    case '4':
                        e.preventDefault();
                        window.location.href = 'licenses.html';
                        break;
                }
            }
        });

        // Animation d'entr√©e
        window.addEventListener('load', () => {
            document.querySelector('main').style.opacity = '0';
            document.querySelector('main').style.transform = 'translateY(20px)';
            setTimeout(() => {
                document.querySelector('main').style.transition = 'all 0.5s ease';
                document.querySelector('main').style.opacity = '1';
                document.querySelector('main').style.transform = 'translateY(0)';
            }, 100);
        });
    </script>
</body>
</html>
