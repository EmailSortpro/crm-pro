<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Pro - Forecast & Opportunit√©s</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Styles sp√©cifiques √† la page Forecast */
        .forecast-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header de page */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            font-size: 1rem;
            font-weight: 400;
            color: #6b7280;
        }

        /* Cartes de m√©triques */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .metric-change {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-top: 0.5rem;
        }

        .metric-card.primary .metric-value { color: #667eea; }
        .metric-card.success .metric-value { color: #10b981; }
        .metric-card.warning .metric-value { color: #f59e0b; }
        .metric-card.danger .metric-value { color: #ef4444; }

        /* Contr√¥les et filtres */
        .controls-section {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-count {
            background: rgba(0,0,0,0.1);
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Tableau des opportunit√©s */
        .opportunities-section {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        .opportunities-table {
            width: 100%;
            border-collapse: collapse;
        }

        .opportunities-table th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .opportunities-table th:hover {
            background: #f3f4f6;
        }

        .opportunities-table th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 1rem;
            opacity: 0.3;
            font-size: 0.75rem;
        }

        .opportunities-table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            color: #667eea;
        }

        .opportunities-table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            color: #667eea;
        }

        .opportunities-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }

        .opportunities-table tr:hover td {
            background: #f9fafb;
        }

        .company-name {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .company-name:hover {
            color: #667eea;
        }

        .opportunity-value {
            font-weight: 600;
            color: #667eea;
            font-size: 1rem;
        }

        .stage-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .stage-prospect { background: #f3f4f6; color: #6b7280; }
        .stage-qualification { background: #dbeafe; color: #1e40af; }
        .stage-proposal { background: #fef3c7; color: #92400e; }
        .stage-negotiation { background: #fed7aa; color: #c2410c; }
        .stage-closing { background: #dcfce7; color: #166534; }

        .probability-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .probability-bar {
            width: 100px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
            transition: width 0.3s ease;
        }

        .probability-text {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }

        /* Actions du tableau */
        .table-actions-cell {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .action-btn {
            padding: 0.375rem 0.625rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .action-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .action-btn.edit {
            color: #3b82f6;
        }

        .action-btn.delete {
            color: #ef4444;
        }

        /* Pagination */
        .pagination-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 2.5rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Graphiques */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chart-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-btn {
            padding: 0.375rem 0.75rem;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chart-btn:hover {
            background: #e5e7eb;
        }

        .chart-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chart-body {
            padding: 1.5rem;
            height: 300px;
        }

        /* Table des pr√©visions */
        .forecast-table {
            width: 100%;
            border-collapse: collapse;
        }

        .forecast-table th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .forecast-table td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .forecast-table tr:hover td {
            background: #f9fafb;
        }

        /* √âtat vide */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            color: #6b7280;
            margin-bottom: 2rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Formulaire */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .form-label.required::after {
            content: ' *';
            color: #ef4444;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Utilitaires */
        .text-muted {
            color: #6b7280;
        }

        .text-small {
            font-size: 0.875rem;
        }

        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .filter-group {
                justify-content: center;
            }
            
            .opportunities-table {
                font-size: 0.875rem;
            }
            
            .opportunities-table th,
            .opportunities-table td {
                padding: 0.75rem 0.5rem;
            }
            
            .table-actions-cell {
                flex-direction: column;
            }
        }

        /* Animation de chargement */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 400px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .notification.success .notification-title {
            color: #10b981;
        }

        .notification.error .notification-title {
            color: #ef4444;
        }

        .notification-message {
            color: #374151;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">üöÄ</span>
                <span class="logo-text">CRM Pro</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">üè†</span>
                    Accueil
                </a>
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">üìä</span>
                    Tableau de bord
                </a>
                <a href="companies.html" class="nav-link">
                    <span class="nav-icon">üè¢</span>
                    Soci√©t√©s
                </a>
                <a href="contacts.html" class="nav-link">
                    <span class="nav-icon">üë•</span>
                    Contacts
                </a>
                <a href="forecast.html" class="nav-link active">
                    <span class="nav-icon">üìà</span>
                    Forecast
                </a>
                <a href="onboarding.html" class="nav-link">
                    <span class="nav-icon">üéØ</span>
                    Onboarding
                </a>
                <a href="licenses.html" class="nav-link">
                    <span class="nav-icon">üìÑ</span>
                    Licences
                </a>
            </div>
            
            <div class="nav-user">
                <div class="user-info">
                    <span class="user-name" id="userName">Chargement...</span>
                    <span class="user-role" id="userRole">...</span>
                </div>
                <button onclick="ForecastManager.logout()" class="logout-btn">
                    <span>üö™</span>
                    D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <!-- Contenu principal -->
    <main class="forecast-container">
        <!-- En-t√™te de page -->
        <div class="page-header">
            <h1 class="page-title">
                üìà Forecast & Opportunit√©s
                <span class="page-subtitle">Analysez vos pr√©visions et g√©rez votre pipeline commercial</span>
            </h1>
        </div>

        <!-- M√©triques principales -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="totalOpportunities">0</div>
                <div class="metric-label">Opportunit√©s Actives</div>
                <div class="metric-change" id="opportunitiesChange">Chargement...</div>
            </div>
            
            <div class="metric-card primary">
                <div class="metric-value" id="totalPipeline">0 ‚Ç¨</div>
                <div class="metric-label">Valeur du Pipeline</div>
                <div class="metric-change" id="pipelineChange">Total des opportunit√©s</div>
            </div>
            
            <div class="metric-card success">
                <div class="metric-value" id="weightedPipeline">0 ‚Ç¨</div>
                <div class="metric-label">Revenus Pond√©r√©s</div>
                <div class="metric-change" id="weightedChange">Bas√© sur les probabilit√©s</div>
            </div>
            
            <div class="metric-card warning">
                <div class="metric-value" id="avgDealSize">0 ‚Ç¨</div>
                <div class="metric-label">Taille Moyenne</div>
                <div class="metric-change" id="dealSizeChange">Par opportunit√©</div>
            </div>
        </div>

        <!-- Contr√¥les et filtres -->
        <div class="controls-section">
            <div class="controls-row">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="search-input" 
                        placeholder="Rechercher une opportunit√©..."
                        onkeyup="ForecastManager.handleSearch()"
                    />
                </div>
                
                <div class="filter-group">
                    <button 
                        class="filter-btn active" 
                        data-stage="all"
                        onclick="ForecastManager.filterByStage('all')"
                    >
                        Toutes
                        <span class="filter-count" id="count-all">0</span>
                    </button>
                    <button 
                        class="filter-btn" 
                        data-stage="prospect"
                        onclick="ForecastManager.filterByStage('prospect')"
                    >
                        Prospect
                        <span class="filter-count" id="count-prospect">0</span>
                    </button>
                    <button 
                        class="filter-btn" 
                        data-stage="qualification"
                        onclick="ForecastManager.filterByStage('qualification')"
                    >
                        Qualification
                        <span class="filter-count" id="count-qualification">0</span>
                    </button>
                    <button 
                        class="filter-btn" 
                        data-stage="proposal"
                        onclick="ForecastManager.filterByStage('proposal')"
                    >
                        Proposition
                        <span class="filter-count" id="count-proposal">0</span>
                    </button>
                    <button 
                        class="filter-btn" 
                        data-stage="negotiation"
                        onclick="ForecastManager.filterByStage('negotiation')"
                    >
                        N√©gociation
                        <span class="filter-count" id="count-negotiation">0</span>
                    </button>
                    <button 
                        class="filter-btn" 
                        data-stage="closing"
                        onclick="ForecastManager.filterByStage('closing')"
                    >
                        Finalisation
                        <span class="filter-count" id="count-closing">0</span>
                    </button>
                </div>
                
                <button class="btn btn-primary" onclick="ForecastManager.openNewOpportunityModal()">
                    ‚ûï Nouvelle Opportunit√©
                </button>
            </div>
        </div>

        <!-- Tableau des opportunit√©s -->
        <div class="opportunities-section" id="opportunitiesSection">
            <div class="table-header">
                <h2 class="table-title">Liste des Opportunit√©s</h2>
                <div class="table-actions">
                    <select class="form-select" id="perPageSelect" onchange="ForecastManager.changePerPage()">
                        <option value="10">10 par page</option>
                        <option value="25" selected>25 par page</option>
                        <option value="50">50 par page</option>
                        <option value="100">100 par page</option>
                    </select>
                </div>
            </div>
            
            <div id="tableContainer">
                <!-- Le tableau sera g√©n√©r√© dynamiquement ici -->
            </div>
            
            <div class="pagination-container" id="paginationContainer">
                <!-- La pagination sera g√©n√©r√©e dynamiquement ici -->
            </div>
        </div>

        <!-- √âtat vide -->
        <div class="opportunities-section" id="emptyState" style="display: none;">
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <h3 class="empty-state-title">Aucune opportunit√© trouv√©e</h3>
                <p class="empty-state-text">
                    Commencez √† suivre vos opportunit√©s commerciales en cr√©ant votre premi√®re opportunit√©.
                </p>
                <button class="btn btn-primary" onclick="ForecastManager.openNewOpportunityModal()">
                    ‚ûï Cr√©er ma premi√®re opportunit√©
                </button>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="charts-section">
            <!-- Graphique des revenus -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">üìä √âvolution des Revenus</h3>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="monthly" onclick="ForecastManager.updateChartPeriod('revenue', 'monthly')">
                            Mensuel
                        </button>
                        <button class="chart-btn" data-period="quarterly" onclick="ForecastManager.updateChartPeriod('revenue', 'quarterly')">
                            Trimestriel
                        </button>
                        <button class="chart-btn" data-period="yearly" onclick="ForecastManager.updateChartPeriod('revenue', 'yearly')">
                            Annuel
                        </button>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            
            <!-- Graphique du pipeline -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">üîÑ R√©partition du Pipeline</h3>
                </div>
                <div class="chart-body">
                    <canvas id="pipelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tableau des pr√©visions -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">üìÖ Pr√©visions par Trimestre</h3>
            </div>
            <div style="overflow-x: auto;">
                <table class="forecast-table">
                    <thead>
                        <tr>
                            <th>P√©riode</th>
                            <th>Nombre d'Opportunit√©s</th>
                            <th>Valeur Totale</th>
                            <th>Revenus Pond√©r√©s</th>
                            <th>Tendance</th>
                        </tr>
                    </thead>
                    <tbody id="forecastTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">
                                Chargement des pr√©visions...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Opportunit√© -->
    <div class="modal-overlay" id="opportunityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nouvelle Opportunit√©</h3>
                <button class="modal-close" onclick="ForecastManager.closeModal()">&times;</button>
            </div>
            
            <form id="opportunityForm" onsubmit="ForecastManager.handleOpportunitySubmit(event)">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" for="companyId">Soci√©t√©</label>
                            <select class="form-select" id="companyId" name="company_id" required>
                                <option value="">S√©lectionner une soci√©t√©</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label required" for="value">Valeur (‚Ç¨)</label>
                            <input 
                                type="number" 
                                class="form-input" 
                                id="value" 
                                name="value" 
                                min="0" 
                                step="0.01" 
                                required
                                placeholder="10000"
                            />
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label required" for="stage">√âtape</label>
                            <select class="form-select" id="stage" name="stage" required onchange="ForecastManager.updateProbability()">
                                <option value="prospect">Prospect</option>
                                <option value="qualification">Qualification</option>
                                <option value="proposal">Proposition</option>
                                <option value="negotiation">N√©gociation</option>
                                <option value="closing">Finalisation</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="probability">Probabilit√© (%)</label>
                            <input 
                                type="number" 
                                class="form-input" 
                                id="probability" 
                                name="probability" 
                                min="0" 
                                max="100" 
                                value="25"
                            />
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="expectedCloseDate">Date de cl√¥ture pr√©vue</label>
                            <input 
                                type="date" 
                                class="form-input" 
                                id="expectedCloseDate" 
                                name="expected_close_date"
                            />
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="source">Source</label>
                            <select class="form-select" id="source" name="source">
                                <option value="">S√©lectionner une source</option>
                                <option value="website">Site web</option>
                                <option value="referral">R√©f√©rence</option>
                                <option value="cold_call">Appel √† froid</option>
                                <option value="marketing">Marketing</option>
                                <option value="partner">Partenaire</option>
                                <option value="event">√âv√©nement</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="notes">Notes</label>
                        <textarea 
                            class="form-textarea" 
                            id="notes" 
                            name="notes" 
                            placeholder="Ajoutez des notes sur cette opportunit√©..."
                        ></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="ForecastManager.closeModal()">
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="submitButtonText">Cr√©er l'opportunit√©</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overlay de chargement -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Container de notifications -->
    <div id="notificationContainer"></div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script>
    // Gestionnaire principal de la page Forecast
    const ForecastManager = {
        // √âtat de l'application
        state: {
            companies: [],
            opportunities: [],
            licenses: [],
            filteredOpportunities: [],
            currentPage: 1,
            itemsPerPage: 25,
            currentSort: { field: 'created_at', direction: 'desc' },
            currentFilter: 'all',
            searchTerm: '',
            charts: {
                revenue: null,
                pipeline: null
            },
            editingOpportunity: null
        },

        // Initialisation
        async init() {
            console.log('üöÄ Initialisation Forecast Manager...');
            
            // V√©rifier l'authentification
            const isAuthenticated = await AuthService.requireAuth();
            if (!isAuthenticated) {
                window.location.href = '/login.html';
                return;
            }

            // Charger les informations utilisateur
            this.loadUserInfo();
            
            // Charger toutes les donn√©es
            await this.loadAllData();
            
            // Initialiser les graphiques
            this.initCharts();
            
            // Mettre √† jour les m√©triques
            this.updateMetrics();
            
            // Configurer les √©couteurs d'√©v√©nements
            this.setupEventListeners();
            
            console.log('‚úÖ Forecast Manager initialis√©');
        },

        // Charger les informations utilisateur
        loadUserInfo() {
            const userInfo = AuthService.getUserInfo();
            if (userInfo) {
                document.getElementById('userName').textContent = userInfo.email.split('@')[0];
                document.getElementById('userRole').textContent = userInfo.role === 'admin' ? 'Admin' : 'Utilisateur';
            }
        },

        // Charger toutes les donn√©es
        async loadAllData() {
            this.showLoading(true);
            
            try {
                // Charger en parall√®le pour gagner du temps
                const [companiesResult, opportunitiesResult, licensesResult] = await Promise.all([
                    CRMService.getCompanies(),
                    CRMService.getOpportunities(),
                    CRMService.getLicenses()
                ]);

                // Traiter les r√©sultats
                if (companiesResult.success) {
                    this.state.companies = companiesResult.data || [];
                    this.populateCompanySelect();
                }

                if (opportunitiesResult.success) {
                    this.state.opportunities = (opportunitiesResult.data || []).map(opp => ({
                        ...opp,
                        company_name: opp.companies?.name || 'Soci√©t√© inconnue'
                    }));
                }

                if (licensesResult.success) {
                    this.state.licenses = licensesResult.data || [];
                }

                // Mettre √† jour l'affichage
                this.applyFilters();
                this.updateCounts();
                
            } catch (error) {
                console.error('‚ùå Erreur chargement donn√©es:', error);
                this.showNotification('error', 'Erreur lors du chargement des donn√©es');
            } finally {
                this.showLoading(false);
            }
        },

        // Populer le select des soci√©t√©s
        populateCompanySelect() {
            const select = document.getElementById('companyId');
            select.innerHTML = '<option value="">S√©lectionner une soci√©t√©</option>';
            
            this.state.companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = `${company.name} (${company.status})`;
                select.appendChild(option);
            });
        },

        // Appliquer les filtres et la recherche
        applyFilters() {
            let filtered = [...this.state.opportunities];
            
            // Filtre par √©tape
            if (this.state.currentFilter !== 'all') {
                filtered = filtered.filter(opp => opp.stage === this.state.currentFilter);
            }
            
            // Filtre par recherche
            if (this.state.searchTerm) {
                const search = this.state.searchTerm.toLowerCase();
                filtered = filtered.filter(opp => 
                    opp.company_name.toLowerCase().includes(search) ||
                    (opp.notes && opp.notes.toLowerCase().includes(search)) ||
                    (opp.source && opp.source.toLowerCase().includes(search))
                );
            }
            
            // Appliquer le tri
            filtered.sort((a, b) => {
                let aVal = a[this.state.currentSort.field];
                let bVal = b[this.state.currentSort.field];
                
                // G√©rer les valeurs num√©riques
                if (this.state.currentSort.field === 'value' || this.state.currentSort.field === 'probability') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                // G√©rer les dates
                if (this.state.currentSort.field === 'expected_close_date') {
                    aVal = new Date(aVal || '2099-12-31');
                    bVal = new Date(bVal || '2099-12-31');
                }
                
                // G√©rer les cha√Ænes de caract√®res
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (this.state.currentSort.direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            this.state.filteredOpportunities = filtered;
            this.renderTable();
        },

        // Rendre le tableau
        renderTable() {
            const start = (this.state.currentPage - 1) * this.state.itemsPerPage;
            const end = start + this.state.itemsPerPage;
            const paginatedData = this.state.filteredOpportunities.slice(start, end);
            
            const container = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');
            const opportunitiesSection = document.getElementById('opportunitiesSection');
            
            if (this.state.filteredOpportunities.length === 0) {
                opportunitiesSection.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            opportunitiesSection.style.display = 'block';
            emptyState.style.display = 'none';
            
            container.innerHTML = `
                <table class="opportunities-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="ForecastManager.sortBy('company_name')">
                                Soci√©t√©
                            </th>
                            <th class="sortable" onclick="ForecastManager.sortBy('value')">
                                Valeur
                            </th>
                            <th class="sortable" onclick="ForecastManager.sortBy('stage')">
                                √âtape
                            </th>
                            <th class="sortable" onclick="ForecastManager.sortBy('probability')">
                                Probabilit√©
                            </th>
                            <th class="sortable" onclick="ForecastManager.sortBy('expected_close_date')">
                                Cl√¥ture pr√©vue
                            </th>
                            <th class="sortable" onclick="ForecastManager.sortBy('source')">
                                Source
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paginatedData.map(opp => this.renderOpportunityRow(opp)).join('')}
                    </tbody>
                </table>
            `;
            
            this.updateSortIndicators();
            this.renderPagination();
        },

        // Rendre une ligne d'opportunit√©
        renderOpportunityRow(opp) {
            return `
                <tr>
                    <td>
                        <div class="company-name" onclick="ForecastManager.viewOpportunity('${opp.id}')">
                            ${this.escapeHtml(opp.company_name)}
                        </div>
                    </td>
                    <td>
                        <span class="opportunity-value">${this.formatCurrency(opp.value)}</span>
                    </td>
                    <td>
                        <span class="stage-badge stage-${opp.stage}">
                            ${this.getStageLabel(opp.stage)}
                        </span>
                    </td>
                    <td>
                        <div class="probability-container">
                            <div class="probability-bar">
                                <div class="probability-fill" style="width: ${opp.probability}%"></div>
                            </div>
                            <span class="probability-text">${opp.probability}%</span>
                        </div>
                    </td>
                    <td>
                        ${opp.expected_close_date ? this.formatDate(opp.expected_close_date) : '-'}
                    </td>
                    <td>
                        ${this.getSourceLabel(opp.source)}
                    </td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="action-btn edit" onclick="ForecastManager.editOpportunity('${opp.id}')" title="Modifier">
                                ‚úèÔ∏è
                            </button>
                            <button class="action-btn delete" onclick="ForecastManager.deleteOpportunity('${opp.id}')" title="Supprimer">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        },

        // Mettre √† jour les indicateurs de tri
        updateSortIndicators() {
            const headers = document.querySelectorAll('.opportunities-table th.sortable');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            const currentHeader = document.querySelector(`.opportunities-table th.sortable:nth-child(${this.getColumnIndex(this.state.currentSort.field)})`);
            if (currentHeader) {
                currentHeader.classList.add(`sort-${this.state.currentSort.direction}`);
            }
        },

        // Obtenir l'index de la colonne
        getColumnIndex(field) {
            const fieldMap = {
                'company_name': 1,
                'value': 2,
                'stage': 3,
                'probability': 4,
                'expected_close_date': 5,
                'source': 6
            };
            return fieldMap[field] || 1;
        },

        // Rendre la pagination
        renderPagination() {
            const totalPages = Math.ceil(this.state.filteredOpportunities.length / this.state.itemsPerPage);
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const start = (this.state.currentPage - 1) * this.state.itemsPerPage + 1;
            const end = Math.min(this.state.currentPage * this.state.itemsPerPage, this.state.filteredOpportunities.length);
            
            let paginationHTML = `
                <div class="pagination-info">
                    Affichage ${start}-${end} sur ${this.state.filteredOpportunities.length} opportunit√©s
                </div>
                <div class="pagination-controls">
            `;
            
            // Boutons pr√©c√©dent
            paginationHTML += `
                <button class="pagination-btn" onclick="ForecastManager.goToPage(1)" ${this.state.currentPage === 1 ? 'disabled' : ''}>
                    ‚èÆ
                </button>
                <button class="pagination-btn" onclick="ForecastManager.goToPage(${this.state.currentPage - 1})" ${this.state.currentPage === 1 ? 'disabled' : ''}>
                    ‚óÄ
                </button>
            `;
            
            // Num√©ros de page
            const startPage = Math.max(1, this.state.currentPage - 2);
            const endPage = Math.min(totalPages, this.state.currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === this.state.currentPage ? 'active' : ''}" onclick="ForecastManager.goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Boutons suivant
            paginationHTML += `
                <button class="pagination-btn" onclick="ForecastManager.goToPage(${this.state.currentPage + 1})" ${this.state.currentPage === totalPages ? 'disabled' : ''}>
                    ‚ñ∂
                </button>
                <button class="pagination-btn" onclick="ForecastManager.goToPage(${totalPages})" ${this.state.currentPage === totalPages ? 'disabled' : ''}>
                    ‚è≠
                </button>
            `;
            
            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
        },

        // Mettre √† jour les m√©triques
        updateMetrics() {
            const totalOpportunities = this.state.opportunities.length;
            const totalPipeline = this.state.opportunities.reduce((sum, opp) => sum + (parseFloat(opp.value) || 0), 0);
            const weightedPipeline = this.state.opportunities.reduce((sum, opp) => 
                sum + ((parseFloat(opp.value) || 0) * (parseInt(opp.probability) || 0) / 100), 0
            );
            const avgDealSize = totalOpportunities > 0 ? totalPipeline / totalOpportunities : 0;
            
            // Mettre √† jour l'affichage
            document.getElementById('totalOpportunities').textContent = totalOpportunities;
            document.getElementById('totalPipeline').textContent = this.formatCurrency(totalPipeline);
            document.getElementById('weightedPipeline').textContent = this.formatCurrency(weightedPipeline);
            document.getElementById('avgDealSize').textContent = this.formatCurrency(avgDealSize);
            
            // Calculer les changements
            const activeOpportunities = this.state.opportunities.filter(opp => 
                ['proposal', 'negotiation', 'closing'].includes(opp.stage)
            ).length;
            
            document.getElementById('opportunitiesChange').textContent = `${activeOpportunities} en cours de closing`;
            
            // Mettre √† jour les compteurs
            this.updateCounts();
            
            // Mettre √† jour le tableau des pr√©visions
            this.updateForecastTable();
        },

        // Mettre √† jour les compteurs
        updateCounts() {
            const counts = {
                all: this.state.opportunities.length,
                prospect: this.state.opportunities.filter(o => o.stage === 'prospect').length,
                qualification: this.state.opportunities.filter(o => o.stage === 'qualification').length,
                proposal: this.state.opportunities.filter(o => o.stage === 'proposal').length,
                negotiation: this.state.opportunities.filter(o => o.stage === 'negotiation').length,
                closing: this.state.opportunities.filter(o => o.stage === 'closing').length
            };
            
            Object.keys(counts).forEach(key => {
                const element = document.getElementById(`count-${key}`);
                if (element) {
                    element.textContent = counts[key];
                }
            });
        },

        // Initialiser les graphiques
        initCharts() {
            this.initRevenueChart();
            this.initPipelineChart();
        },

        // Initialiser le graphique des revenus
        initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Pr√©parer les donn√©es
            const months = [];
            const projectedRevenue = [];
            const actualRevenue = [];
            
            // Calculer les revenus actuels depuis les licences
            const currentMonthlyRevenue = this.state.licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (parseFloat(l.monthly_cost) || 0), 0);
            
            // Projeter sur 6 mois
            for (let i = 0; i < 6; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() + i);
                months.push(date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }));
                
                // Calculer les revenus projet√©s bas√©s sur les opportunit√©s
                const monthlyProjected = this.state.opportunities
                    .filter(opp => {
                        const closeDate = new Date(opp.expected_close_date);
                        return closeDate <= date;
                    })
                    .reduce((sum, opp) => {
                        const value = parseFloat(opp.value) || 0;
                        const probability = parseInt(opp.probability) || 0;
                        return sum + (value * probability / 100 / 12); // Divis√© par 12 pour mensuel
                    }, 0);
                
                projectedRevenue.push(currentMonthlyRevenue + monthlyProjected);
                actualRevenue.push(i === 0 ? currentMonthlyRevenue : null);
            }
            
            // Cr√©er le graphique
            this.state.charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Revenus Projet√©s',
                            data: projectedRevenue,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Revenus Actuels',
                            data: actualRevenue,
                            borderColor: '#10b981',
                            borderWidth: 3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => this.formatCurrency(value)
                            }
                        }
                    }
                }
            });
        },

        // Initialiser le graphique du pipeline
        initPipelineChart() {
            const ctx = document.getElementById('pipelineChart').getContext('2d');
            
            // Compter les opportunit√©s par √©tape
            const stageCounts = {
                prospect: this.state.opportunities.filter(o => o.stage === 'prospect').length,
                qualification: this.state.opportunities.filter(o => o.stage === 'qualification').length,
                proposal: this.state.opportunities.filter(o => o.stage === 'proposal').length,
                negotiation: this.state.opportunities.filter(o => o.stage === 'negotiation').length,
                closing: this.state.opportunities.filter(o => o.stage === 'closing').length
            };
            
            // Cr√©er le graphique
            this.state.charts.pipeline = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Prospect', 'Qualification', 'Proposition', 'N√©gociation', 'Finalisation'],
                    datasets: [{
                        data: Object.values(stageCounts),
                        backgroundColor: [
                            '#6b7280',
                            '#3b82f6',
                            '#f59e0b',
                            '#ef4444',
                            '#10b981'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });
        },

        // Mettre √† jour le tableau des pr√©visions
        updateForecastTable() {
            const tbody = document.getElementById('forecastTableBody');
            const quarters = [];
            
            // Calculer les 4 prochains trimestres
            for (let i = 0; i < 4; i++) {
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() + (i * 3));
                startDate.setDate(1);
                
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + 3);
                endDate.setDate(0);
                
                const quarterOpps = this.state.opportunities.filter(opp => {
                    const closeDate = new Date(opp.expected_close_date);
                    return closeDate >= startDate && closeDate <= endDate;
                });
                
                const totalValue = quarterOpps.reduce((sum, opp) => sum + (parseFloat(opp.value) || 0), 0);
                const weightedValue = quarterOpps.reduce((sum, opp) => 
                    sum + ((parseFloat(opp.value) || 0) * (parseInt(opp.probability) || 0) / 100), 0
                );
                
                quarters.push({
                    name: `T${Math.floor(startDate.getMonth() / 3) + 1} ${startDate.getFullYear()}`,
                    count: quarterOpps.length,
                    totalValue,
                    weightedValue
                });
            }
            
            // Rendre le tableau
            tbody.innerHTML = quarters.map(q => `
                <tr>
                    <td><strong>${q.name}</strong></td>
                    <td>${q.count}</td>
                    <td>${this.formatCurrency(q.totalValue)}</td>
                    <td><strong style="color: #667eea;">${this.formatCurrency(q.weightedValue)}</strong></td>
                    <td style="font-size: 1.25rem;">
                        ${q.count > 0 ? 'üìà' : 'üìä'}
                    </td>
                </tr>
            `).join('');
        },

        // Gestionnaires d'√©v√©nements
        setupEventListeners() {
            // Fermer les modals en cliquant sur l'overlay
            document.getElementById('opportunityModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    this.closeModal();
                }
            });
            
            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeModal();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    this.openNewOpportunityModal();
                }
            });
        },

        // Actions utilisateur
        handleSearch() {
            this.state.searchTerm = document.getElementById('searchInput').value;
            this.state.currentPage = 1;
            this.applyFilters();
        },

        filterByStage(stage) {
            this.state.currentFilter = stage;
            this.state.currentPage = 1;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.stage === stage);
            });
            
            this.applyFilters();
        },

        sortBy(field) {
            if (this.state.currentSort.field === field) {
                this.state.currentSort.direction = this.state.currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                this.state.currentSort.field = field;
                this.state.currentSort.direction = 'asc';
            }
            
            this.applyFilters();
        },

        changePerPage() {
            this.state.itemsPerPage = parseInt(document.getElementById('perPageSelect').value);
            this.state.currentPage = 1;
            this.renderTable();
        },

        goToPage(page) {
            this.state.currentPage = page;
            this.renderTable();
        },

        // Gestion des opportunit√©s
        openNewOpportunityModal() {
            this.state.editingOpportunity = null;
            document.getElementById('modalTitle').textContent = 'Nouvelle Opportunit√©';
            document.getElementById('submitButtonText').textContent = 'Cr√©er l\'opportunit√©';
            document.getElementById('opportunityForm').reset();
            
            // D√©finir une date par d√©faut (30 jours dans le futur)
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 30);
            document.getElementById('expectedCloseDate').value = futureDate.toISOString().split('T')[0];
            
            // D√©finir la probabilit√© par d√©faut
            this.updateProbability();
            
            // Afficher le modal
            document.getElementById('opportunityModal').classList.add('show');
        },

        async editOpportunity(id) {
            const opportunity = this.state.opportunities.find(o => o.id === id);
            if (!opportunity) return;
            
            this.state.editingOpportunity = opportunity;
            
            // Remplir le formulaire
            document.getElementById('modalTitle').textContent = 'Modifier l\'opportunit√©';
            document.getElementById('submitButtonText').textContent = 'Sauvegarder les modifications';
            
            document.getElementById('companyId').value = opportunity.company_id;
            document.getElementById('value').value = opportunity.value;
            document.getElementById('stage').value = opportunity.stage;
            document.getElementById('probability').value = opportunity.probability;
            document.getElementById('expectedCloseDate').value = opportunity.expected_close_date;
            document.getElementById('source').value = opportunity.source || '';
            document.getElementById('notes').value = opportunity.notes || '';
            
            // Afficher le modal
            document.getElementById('opportunityModal').classList.add('show');
        },

        async viewOpportunity(id) {
            const opportunity = this.state.opportunities.find(o => o.id === id);
            if (!opportunity) return;
            
            // Pour l'instant, on ouvre en mode √©dition
            // On pourrait cr√©er un modal de vue s√©par√© si n√©cessaire
            this.editOpportunity(id);
        },

        async deleteOpportunity(id) {
            const opportunity = this.state.opportunities.find(o => o.id === id);
            if (!opportunity) return;
            
            const confirmed = confirm(
                `√ätes-vous s√ªr de vouloir supprimer l'opportunit√© "${opportunity.company_name}" ` +
                `d'une valeur de ${this.formatCurrency(opportunity.value)} ?\n\n` +
                `Cette action est irr√©versible.`
            );
            
            if (!confirmed) return;
            
            this.showLoading(true);
            
            try {
                const result = await CRMService.deleteOpportunity(id);
                
                if (result.success) {
                    this.showNotification('success', 'Opportunit√© supprim√©e avec succ√®s');
                    await this.loadAllData();
                    this.updateMetrics();
                    this.updateCharts();
                } else {
                    this.showNotification('error', result.error || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur suppression:', error);
                this.showNotification('error', 'Erreur lors de la suppression de l\'opportunit√©');
            } finally {
                this.showLoading(false);
            }
        },

        async handleOpportunitySubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                company_id: formData.get('company_id'),
                value: parseFloat(formData.get('value')) || 0,
                stage: formData.get('stage'),
                probability: parseInt(formData.get('probability')) || 0,
                expected_close_date: formData.get('expected_close_date') || null,
                source: formData.get('source') || null,
                notes: formData.get('notes') || null
            };
            
            // Validation
            if (!data.company_id) {
                this.showNotification('error', 'Veuillez s√©lectionner une soci√©t√©');
                return;
            }
            
            if (data.value <= 0) {
                this.showNotification('error', 'La valeur doit √™tre sup√©rieure √† 0');
                return;
            }
            
            this.showLoading(true);
            
            try {
                let result;
                
                if (this.state.editingOpportunity) {
                    result = await CRMService.updateOpportunity(this.state.editingOpportunity.id, data);
                } else {
                    result = await CRMService.createOpportunity(data);
                }
                
                if (result.success) {
                    this.showNotification(
                        'success', 
                        this.state.editingOpportunity ? 'Opportunit√© modifi√©e avec succ√®s' : 'Opportunit√© cr√©√©e avec succ√®s'
                    );
                    this.closeModal();
                    await this.loadAllData();
                    this.updateMetrics();
                    this.updateCharts();
                } else {
                    this.showNotification('error', result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                this.showNotification('error', 'Erreur lors de la sauvegarde de l\'opportunit√©');
            } finally {
                this.showLoading(false);
            }
        },

        closeModal() {
            document.getElementById('opportunityModal').classList.remove('show');
            this.state.editingOpportunity = null;
        },

        updateProbability() {
            const stage = document.getElementById('stage').value;
            const probabilityMap = {
                'prospect': 25,
                'qualification': 40,
                'proposal': 60,
                'negotiation': 75,
                'closing': 90
            };
            
            document.getElementById('probability').value = probabilityMap[stage] || 25;
        },

        // Gestion des graphiques
        updateCharts() {
            // Mettre √† jour le graphique des revenus
            if (this.state.charts.revenue) {
                this.updateRevenueChart();
            }
            
            // Mettre √† jour le graphique du pipeline
            if (this.state.charts.pipeline) {
                this.updatePipelineChart();
            }
        },

        updateRevenueChart() {
            // Recalculer les donn√©es
            const months = [];
            const projectedRevenue = [];
            const actualRevenue = [];
            
            const currentMonthlyRevenue = this.state.licenses
                .filter(l => l.status === 'active')
                .reduce((sum, l) => sum + (parseFloat(l.monthly_cost) || 0), 0);
            
            for (let i = 0; i < 6; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() + i);
                months.push(date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' }));
                
                const monthlyProjected = this.state.opportunities
                    .filter(opp => {
                        const closeDate = new Date(opp.expected_close_date);
                        return closeDate <= date;
                    })
                    .reduce((sum, opp) => {
                        const value = parseFloat(opp.value) || 0;
                        const probability = parseInt(opp.probability) || 0;
                        return sum + (value * probability / 100 / 12);
                    }, 0);
                
                projectedRevenue.push(currentMonthlyRevenue + monthlyProjected);
                actualRevenue.push(i === 0 ? currentMonthlyRevenue : null);
            }
            
            // Mettre √† jour le graphique
            this.state.charts.revenue.data.labels = months;
            this.state.charts.revenue.data.datasets[0].data = projectedRevenue;
            this.state.charts.revenue.data.datasets[1].data = actualRevenue;
            this.state.charts.revenue.update();
        },

        updatePipelineChart() {
            const stageCounts = {
                prospect: this.state.opportunities.filter(o => o.stage === 'prospect').length,
                qualification: this.state.opportunities.filter(o => o.stage === 'qualification').length,
                proposal: this.state.opportunities.filter(o => o.stage === 'proposal').length,
                negotiation: this.state.opportunities.filter(o => o.stage === 'negotiation').length,
                closing: this.state.opportunities.filter(o => o.stage === 'closing').length
            };
            
            this.state.charts.pipeline.data.datasets[0].data = Object.values(stageCounts);
            this.state.charts.pipeline.update();
        },

        updateChartPeriod(chartType, period) {
            // Mettre √† jour les boutons
            document.querySelectorAll(`.chart-controls button`).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            
            // TODO: Impl√©menter la logique pour changer la p√©riode d'affichage
            // Pour l'instant, on garde juste la visualisation mensuelle
        },

        // Utilitaires
        formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        },

        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        },

        getStageLabel(stage) {
            const labels = {
                'prospect': 'Prospect',
                'qualification': 'Qualification',
                'proposal': 'Proposition',
                'negotiation': 'N√©gociation',
                'closing': 'Finalisation'
            };
            return labels[stage] || stage;
        },

        getSourceLabel(source) {
            const labels = {
                'website': 'Site web',
                'referral': 'R√©f√©rence',
                'cold_call': 'Appel √† froid',
                'marketing': 'Marketing',
                'partner': 'Partenaire',
                'event': '√âv√©nement'
            };
            return labels[source] || source || '-';
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        // Affichage des notifications et du chargement
        showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        },

        showNotification(type, message) {
            const container = document.getElementById('notificationContainer');
            const id = `notification-${Date.now()}`;
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-title">${type === 'success' ? 'Succ√®s' : 'Erreur'}</div>
                <div class="notification-message">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // Animer l'entr√©e
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Retirer apr√®s 5 secondes
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        },

        // D√©connexion
        logout() {
            AuthService.logout();
        }
    };

    // Initialiser l'application au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
        ForecastManager.init();
    });

    // Exposer certaines m√©thodes globalement pour les tests
    window.ForecastManager = ForecastManager;
    </script>
</body>
</html>
